# 糖尿病知识库RAG检索服务方案

## 📋 服务定位

本RAG检索服务作为**专门的知识检索工具**，集成到现有的MCP工具生态中，为Agent智能问答系统提供专业的糖尿病医学知识检索能力。

### 🎯 核心价值

- **专业检索**：基于284条专业翻译的糖尿病QA数据提供精准检索
- **无缝集成**：作为MCP工具直接被Agent调用，无需修改现有架构
- **智能缓存**：利用Redis缓存提升检索性能和用户体验
- **轻量高效**：专注检索服务，不涉及对话生成逻辑

## 🏗️ 系统架构整合

### 现有系统架构
```
用户请求 → Frontend → Agent Service → DeepSeek API
                           ↓
                    MCP Tools (健康记录、医生查询等)
                           ↓  
                    MySQL + MongoDB
```

### 集成后架构
```
用户请求 → Frontend → Agent Service → DeepSeek API
                           ↓
                    MCP Tools (健康记录、医生查询、💡RAG检索)
                           ↓                        ↓
                    MySQL + MongoDB              Chroma + Redis
```

## 🔧 技术栈选型

### 核心组件
- **向量数据库**：ChromaDB - 轻量级、易部署、Python原生
- **缓存系统**：Redis - 复用现有缓存基础设施  
- **向量模型**：BGE-large-zh - 中文医学文本理解优秀
- **集成方式**：MCP工具 - 无缝集成到现有工具生态

### 技术优势
- **ChromaDB**：无需复杂部署，本地文件存储，适合中小规模数据
- **Redis缓存**：复用现有基础设施，降低部署成本
- **MCP集成**：统一的工具调用接口，Agent无需额外适配

## 📊 数据处理流程

### 1. 数据准备阶段
```
diabetes_qa_chinese.csv → 数据清洗 → 文本分块 → 向量化 → ChromaDB存储
                                                       ↓
                                              元数据索引 → Redis缓存
```

### 2. 检索服务阶段  
```
Agent查询 → MCP工具调用 → Redis缓存检查 → ChromaDB向量检索 → 结果排序 → 返回Agent
```

## 🛠️ 服务实现方案

### MCP工具设计

新增`diabetes_knowledge_search`工具，提供以下检索能力：

**工具接口**：
- `query`: 用户问题或症状描述
- `top_k`: 返回相关结果数量（默认5）
- `similarity_threshold`: 相似度阈值（默认0.7）
- `cache_minutes`: 缓存时间（默认30分钟）

**返回格式**：
```json
{
  "success": true,
  "results": [
    {
      "question": "什么是糖尿病视网膜病变？",
      "answer": "糖尿病视网膜病变是...",
      "similarity_score": 0.95,
      "category": "并发症",
      "source": "diabetes_qa"
    }
  ],
  "query_info": {
    "processed_query": "视网膜病变症状",
    "search_time": "0.05s", 
    "cache_hit": false
  }
}
```

### 检索优化策略

#### 1. 智能查询预处理
- **医学术语标准化**：统一同义词表达
- **关键词提取**：提取核心医学概念
- **查询扩展**：基于医学知识图谱扩展相关术语

#### 2. 多层次检索
- **精确匹配**：Redis哈希表存储常见问题快速匹配
- **语义检索**：ChromaDB向量相似度搜索
- **混合排序**：结合文本匹配和语义相似度

#### 3. 缓存策略
- **查询缓存**：相同问题直接返回缓存结果
- **热点数据**：常问问题预加载到Redis
- **智能更新**：数据更新时自动清理相关缓存

## 🚀 部署集成方案

### 1. 服务部署
```
rag/
├── service/
│   ├── rag_service.py      # 核心检索服务
│   ├── chroma_client.py    # ChromaDB客户端
│   ├── redis_cache.py      # Redis缓存管理
│   └── embedding_model.py  # 向量化模型
├── data/
│   ├── chroma_db/          # ChromaDB数据文件
│   └── processed_data/     # 预处理后的数据
└── tools/
    └── mcp_rag_tool.py     # MCP工具实现
```

### 2. MCP集成步骤

**第一步**：在现有`mcp/server.py`中新增RAG工具
**第二步**：Agent自动识别并可调用新工具
**第三步**：用户问糖尿病相关问题时自动触发检索

### 3. 配置管理
```python
RAG_CONFIG = {
    "chroma_path": "./rag/data/chroma_db",
    "redis_config": {
        "host": "localhost", 
        "port": 6379,
        "db": 2  # 使用独立的数据库
    },
    "embedding_model": "BAAI/bge-large-zh-v1.5",
    "similarity_threshold": 0.7,
    "max_results": 10,
    "cache_ttl": 1800  # 30分钟缓存
}
```

## 📈 性能优化

### 检索性能
- **ChromaDB**：内存映射，毫秒级检索响应
- **Redis缓存**：常见问题<10ms响应时间
- **批量处理**：支持一次查询多个相关问题

### 准确性提升
- **专业词典**：糖尿病医学术语词典
- **同义词映射**：医学概念标准化
- **相关性调优**：基于实际使用反馈优化

### 可扩展性
- **数据增量更新**：支持新增医学知识
- **多疾病扩展**：架构支持其他疾病知识库
- **API标准化**：统一的检索接口设计

## 💡 Agent集成效果

### 使用场景示例

**场景1：症状咨询**
```
用户: "最近视力模糊，和糖尿病有关系吗？"
Agent: 调用diabetes_knowledge_search工具
结果: 返回糖尿病视网膜病变相关知识
Agent: 基于检索结果生成专业回答
```

**场景2：治疗建议**  
```
用户: "糖尿病视网膜病变怎么治疗？"
Agent: 调用diabetes_knowledge_search工具
结果: 返回治疗方法、注意事项等知识
Agent: 结合用户健康记录生成个性化建议
```

### 工具协同优势
- **知识检索** + **健康记录查询** = 个性化医疗建议
- **医生推荐** + **疾病知识** = 精准科室匹配
- **症状分析** + **专业知识** = 智能初步诊断

## 🔒 质量保障

### 数据质量
- **专业翻译**：已通过DeepSeek API专业医学翻译
- **术语一致性**：统一的医学术语体系
- **定期更新**：基于最新医学指南更新知识

### 检索准确性  
- **阈值控制**：相似度低于阈值的结果不返回
- **结果验证**：多层次验证确保相关性
- **反馈机制**：收集用户反馈持续优化

### 安全性考虑
- **免责声明**：明确标注仅供参考，需专业医生诊断
- **权限控制**：仅认证用户可访问检索服务
- **敏感信息**：避免返回具体诊断或用药建议

## 📅 实施计划

### Phase 1：基础搭建（1周）
- **Day 1-2**：数据预处理和向量化
- **Day 3-4**：ChromaDB部署和数据导入  
- **Day 5-7**：MCP工具开发和测试

### Phase 2：功能完善（1周）
- **Day 8-10**：Redis缓存集成
- **Day 11-12**：检索优化和性能调优
- **Day 13-14**：Agent集成测试

### Phase 3：部署上线（3天）
- **Day 15-16**：生产环境部署
- **Day 17**：监控配置和上线验证

## 💰 资源需求

### 硬件资源
- **存储空间**：ChromaDB约100MB，Redis缓存50MB
- **内存需求**：向量模型300MB，检索服务200MB
- **CPU要求**：2核心即可满足并发检索需求

### 运维成本
- **部署简单**：ChromaDB无需额外服务，Redis复用现有
- **维护成本低**：数据量小，更新频率低
- **监控集成**：复用现有监控体系

## 🎁 预期收益

### 用户体验提升
- **专业知识**：提供权威的糖尿病医学知识
- **快速响应**：毫秒级检索响应时间
- **智能匹配**：根据用户问题智能匹配最相关知识

### 系统能力增强
- **知识增强**：Agent具备专业医学知识检索能力
- **准确性提升**：基于权威知识库，减少幻觉问题
- **可扩展性**：为后续多疾病知识库奠定基础

### 医疗价值
- **辅助诊断**：为用户提供初步的症状分析
- **健康教育**：普及糖尿病相关医学知识  
- **就医指导**：帮助用户了解何时需要就医

---

## 📝 总结

本RAG检索服务方案完全基于您现有的系统架构设计，作为MCP工具无缝集成到Agent服务中。通过ChromaDB+Redis的轻量级技术栈，以最小的部署成本为系统增加专业的医学知识检索能力。

**核心优势**：
- ✅ 无需修改现有Agent逻辑
- ✅ 复用现有基础设施（Redis）
- ✅ 轻量级部署（ChromaDB）
- ✅ 专业医学知识支持
- ✅ 快速上线（2-3周完成）

该方案为您的智能医疗咨询系统增加了重要的知识检索能力，显著提升了Agent回答的专业性和准确性。 