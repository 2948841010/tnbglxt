<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.tlbglxt.mapper.FileRecordMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="org.example.tlbglxt.entity.FileRecord">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="original_name" property="originalName" jdbcType="VARCHAR"/>
        <result column="file_name" property="fileName" jdbcType="VARCHAR"/>
        <result column="file_path" property="filePath" jdbcType="VARCHAR"/>
        <result column="file_url" property="fileUrl" jdbcType="VARCHAR"/>
        <result column="file_size" property="fileSize" jdbcType="BIGINT"/>
        <result column="content_type" property="contentType" jdbcType="VARCHAR"/>
        <result column="extension" property="extension" jdbcType="VARCHAR"/>
        <result column="category" property="category" jdbcType="VARCHAR"/>
        <result column="business_id" property="businessId" jdbcType="BIGINT"/>
        <result column="business_type" property="businessType" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="TINYINT"/>
        <result column="is_deleted" property="isDeleted" jdbcType="TINYINT"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="create_by" property="createBy" jdbcType="BIGINT"/>
        <result column="update_by" property="updateBy" jdbcType="BIGINT"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 基础字段 -->
    <sql id="Base_Column_List">
        id, original_name, file_name, file_path, file_url, file_size, content_type, 
        extension, category, business_id, business_type, status, is_deleted, 
        create_time, update_time, create_by, update_by, remark
    </sql>

    <!-- 插入文件记录 -->
    <insert id="insert" parameterType="org.example.tlbglxt.entity.FileRecord" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sys_file_record (
            original_name, file_name, file_path, file_url, file_size, 
            content_type, extension, category, business_id, business_type, 
            status, is_deleted, create_time, update_time, create_by, update_by, remark
        ) VALUES (
            #{originalName}, #{fileName}, #{filePath}, #{fileUrl}, #{fileSize},
            #{contentType}, #{extension}, #{category}, #{businessId}, #{businessType},
            #{status}, #{isDeleted}, #{createTime}, #{updateTime}, #{createBy}, #{updateBy}, #{remark}
        )
    </insert>

    <!-- 根据ID查询 -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_file_record
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- 更新文件记录 -->
    <update id="updateById" parameterType="org.example.tlbglxt.entity.FileRecord">
        UPDATE sys_file_record
        <set>
            <if test="originalName != null">original_name = #{originalName},</if>
            <if test="fileName != null">file_name = #{fileName},</if>
            <if test="filePath != null">file_path = #{filePath},</if>
            <if test="fileUrl != null">file_url = #{fileUrl},</if>
            <if test="fileSize != null">file_size = #{fileSize},</if>
            <if test="contentType != null">content_type = #{contentType},</if>
            <if test="extension != null">extension = #{extension},</if>
            <if test="category != null">category = #{category},</if>
            <if test="businessId != null">business_id = #{businessId},</if>
            <if test="businessType != null">business_type = #{businessType},</if>
            <if test="status != null">status = #{status},</if>
            <if test="isDeleted != null">is_deleted = #{isDeleted},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="remark != null">remark = #{remark},</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 根据业务ID和类型查询 -->
    <select id="selectByBusiness" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_file_record
        WHERE business_id = #{businessId} 
          AND business_type = #{businessType} 
          AND is_deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 根据分类和业务ID查询 -->
    <select id="selectByCategory" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_file_record
        WHERE category = #{category} 
          AND business_id = #{businessId} 
          AND is_deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 根据用户ID查询 -->
    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_file_record
        WHERE create_by = #{userId} AND is_deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 软删除 -->
    <update id="deleteById">
        UPDATE sys_file_record 
        SET is_deleted = 1, update_time = NOW(), update_by = #{userId}
        WHERE id = #{id}
    </update>

    <!-- 批量软删除 -->
    <update id="batchDeleteByIds">
        UPDATE sys_file_record 
        SET is_deleted = 1, update_time = NOW(), update_by = #{userId}
        WHERE id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </update>

    <!-- 查询过期文件 -->
    <select id="selectExpiredFiles" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_file_record
        WHERE is_deleted = 1 
          AND update_time &lt; DATE_SUB(NOW(), INTERVAL #{days} DAY)
        ORDER BY update_time ASC
    </select>

</mapper> 